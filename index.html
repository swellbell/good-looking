<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2026 Product P&L</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Manrope', sans-serif;
    background: #EAF3F9;
    color: #170035;
    font-size: 14px;
    line-height: 1.5;
    min-height: 100vh;
    padding: 28px 20px;
  }

  .container { max-width: 1100px; margin: 0 auto; }

  /* HEADER */
  .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
  .section-header h2 { font-size: 22px; font-weight: 800; color: #170035; letter-spacing: -0.03em; white-space: nowrap; }
  .section-header .line {
    flex: 1; height: 2px;
    background: linear-gradient(90deg, #1500FF, #00D7D9, transparent);
    border-radius: 2px;
  }

  /* STAT CHIPS */
  .stat-row { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
  .stat-chip {
    background: #ffffff; border: 1px solid #D1DDE5; border-top: 3px solid #1500FF;
    border-radius: 8px; padding: 12px 16px;
    flex: 1; min-width: 130px; text-align: center;
    box-shadow: 0 1px 4px rgba(21,0,255,0.07);
  }
  .stat-chip .num { font-size: 22px; font-weight: 800; color: #1500FF; display: block; letter-spacing: -0.02em; line-height: 1.2; }
  .stat-chip .label { font-size: 11px; color: #9FA4BC; font-weight: 500; margin-top: 2px; display: block; }

  .footnote { font-size: 11px; color: #9FA4BC; margin-bottom: 18px; padding-left: 2px; }
  .footnote span { color: #00D7D9; font-weight: 700; }

  /* CARDS */
  .card {
    background: #ffffff; border: 1px solid #D1DDE5; border-radius: 10px;
    padding: 18px; margin-bottom: 14px;
    box-shadow: 0 1px 4px rgba(21,0,255,0.07);
  }
  .card-title {
    font-size: 10px; font-weight: 800; text-transform: uppercase;
    letter-spacing: 0.12em; color: #1500FF; margin-bottom: 14px;
  }

  /* GRID */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  @media (max-width: 700px) { .grid-2 { grid-template-columns: 1fr; } }

  /* TABLE */
  .pl-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .pl-table thead tr { border-bottom: 2px solid #D1DDE5; }
  .pl-table th {
    padding: 8px 10px; color: #9FA4BC; font-size: 11px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.05em;
  }
  .pl-table th:first-child { text-align: left; }
  .pl-table th:not(:first-child):not(:last-child) { text-align: right; }
  .pl-table th:last-child { text-align: left; width: 110px; }

  .row-parent { border-bottom: 1px solid #D1DDE5; }
  .row-parent:hover { background: #f5f9fc; }
  .row-parent td { padding: 10px 10px; font-weight: 700; color: #170035; }
  .row-capture td:first-child { border-left: 3px solid #00D7D9; padding-left: 9px; }

  .row-child { border-bottom: 1px solid #EAF3F9; background: #fafcfd; }
  .row-child:hover { background: #EAF3F9; }
  .row-child td { padding: 6px 10px; font-size: 12px; font-weight: 500; color: #5a6080; }
  .row-child td:first-child { padding-left: 30px; }
  .row-child td.num { font-size: 12px; font-weight: 500; }

  .child-prefix { color: #C6C9E0; margin-right: 4px; font-size: 12px; }
  .child-tag {
    font-size: 9px; font-weight: 700; color: #9FA4BC;
    background: #EAF3F9; border: 1px solid #D1DDE5;
    border-radius: 3px; padding: 1px 5px;
    text-transform: uppercase; letter-spacing: 0.05em;
    margin-left: 6px; vertical-align: middle;
  }

  .pl-table td.num { text-align: right; font-weight: 600; font-variant-numeric: tabular-nums; }

  .pl-table tfoot tr { border-top: 2px solid #170035; background: #EAF3F9; }
  .pl-table tfoot td { padding: 10px 10px; font-weight: 800; font-size: 13px; }
  .pl-table tfoot td.num { text-align: right; font-variant-numeric: tabular-nums; }
  .pl-table tfoot td:first-child { border-left: 3px solid #1500FF; padding-left: 9px; }

  .bar-track { background: #D1DDE5; border-radius: 4px; height: 8px; width: 100%; overflow: hidden; }
  .bar-fill  { height: 100%; border-radius: 4px; }

  /* REF TABLE */
  .ref-table { width: 100%; border-collapse: collapse; }
  .ref-table tr { border-bottom: 1px solid #EAF3F9; }
  .ref-table tr:last-child { border-bottom: none; }
  .ref-table td { padding: 7px 8px; font-size: 13px; vertical-align: top; }
  .ref-table td:first-child { color: #9FA4BC; font-size: 11px; font-weight: 600; white-space: nowrap; width: 160px; padding-top: 9px; }
  .ref-table td:last-child { font-weight: 600; text-align: right; }

  /* NARRATIVE */
  .narrative-card {
    background: linear-gradient(135deg, #DCE8F2, #EAF3F9);
    border: 1px solid #00D7D9; border-radius: 10px;
    padding: 18px; margin-top: 14px;
  }
  .narrative-card .card-title { color: #1500FF; }
  .narrative-card p { font-size: 13px; line-height: 1.75; color: #170035; }
  .narrative-card strong.a { color: #1500FF; }
  .narrative-card strong.b { color: #00BC9E; }

  /* ── BUBBLE CHART SECTION ── */
  .bubble-section { margin-top: 14px; }

  .bubble-controls {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }

  .threshold-control {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #EAF3F9;
    border: 1px solid #D1DDE5;
    border-radius: 6px;
    padding: 7px 14px;
  }

  .threshold-control label {
    font-size: 12px;
    font-weight: 700;
    color: #170035;
    white-space: nowrap;
  }

  input[type="range"] {
    -webkit-appearance: none;
    width: 130px;
    height: 4px;
    background: #D1DDE5;
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px; height: 14px;
    border-radius: 50%;
    background: #1500FF;
    cursor: pointer;
    border: 2px solid #fff;
    box-shadow: 0 0 0 1px #1500FF;
  }

  #threshold-display {
    font-size: 13px;
    font-weight: 800;
    color: #ED4F63;
    min-width: 34px;
  }

  .ctl-hint {
    font-size: 11px;
    font-weight: 600;
    color: #9FA4BC;
  }

  .bubble-legend {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-top: 14px;
    align-items: center;
  }

  .bubble-legend-item {
    display: flex;
    align-items: center;
    gap: 7px;
    font-size: 11px;
    font-weight: 600;
    color: #170035;
  }

  .leg-swatch {
    width: 11px; height: 11px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .leg-dash {
    width: 22px; height: 0;
    border-top: 2px dashed #ED4F63;
    flex-shrink: 0;
  }

  /* D3 SVG overrides scoped inside #bubble-wrap */
  #bubble-wrap .tick text {
    font-family: 'Manrope', sans-serif;
    font-size: 10px;
    font-weight: 600;
    fill: #9FA4BC;
  }
  #bubble-wrap .tick line { stroke: #DCE8F2; }
  #bubble-wrap .domain { display: none; }
  #bubble-wrap .bgrid line { stroke: #EAF3F9; stroke-dasharray: 4,3; }
  #bubble-wrap .bGrid path { display: none; }

  /* D3 tooltip */
  #bubble-tooltip {
    position: fixed;
    background: #170035;
    color: #fff;
    border-radius: 6px;
    padding: 12px 16px;
    font-family: 'Manrope', sans-serif;
    font-size: 11px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.12s;
    min-width: 220px;
    z-index: 200;
    line-height: 1.8;
    box-shadow: 0 6px 24px rgba(21,0,255,0.2);
  }
  #bubble-tooltip .t-name {
    font-size: 13px; font-weight: 700; color: #00D7D9;
    margin-bottom: 6px; display: block;
  }
  #bubble-tooltip .t-divider {
    border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 6px 0;
  }
  #bubble-tooltip .t-row {
    display: flex; justify-content: space-between; gap: 14px;
    font-weight: 500; color: #aab0cc;
  }
  #bubble-tooltip .t-row span:last-child { color: #fff; font-weight: 700; }
  #bubble-tooltip .t-section {
    font-size: 9px; font-weight: 700; letter-spacing: 0.1em;
    text-transform: uppercase; color: rgba(255,255,255,0.35);
    margin-top: 6px; margin-bottom: 2px;
  }
</style>
</head>
<body>
<div class="container">

  <div class="section-header">
    <h2>2026 Product P&L</h2>
    <div class="line"></div>
  </div>

  <div class="stat-row">
    <div class="stat-chip"><span class="num">$383.6M</span><span class="label">Total Revenue (FCST)</span></div>
    <div class="stat-chip"><span class="num">$156.2M</span><span class="label">Total Expenses (FCST)</span></div>
    <div class="stat-chip"><span class="num">$227.4M</span><span class="label">Total Profit (FCST)</span></div>
    <div class="stat-chip"><span class="num">59.3%</span><span class="label">Overall Margin (FCST)</span></div>
    <div class="stat-chip"><span class="num" style="color:#00BC9E;">+$500K</span><span class="label">Revenue vs. Budget</span></div>
  </div>
  <p class="footnote"><span>↳</span> Totals reflect 6 top-level products. Mobile &amp; Desktop are sub-components of Capture and are excluded to avoid double-counting.</p>

  <!-- TABLE -->
  <div class="card">
    <div class="card-title">FY26 Current Forecast by Product — All figures in $thousands</div>
    <table class="pl-table">
      <thead>
        <tr>
          <th style="text-align:left;">Product</th>
          <th>Revenue</th>
          <th>Expenses</th>
          <th>Profit</th>
          <th>Margin</th>
          <th>vs Budget</th>
          <th>YoY Rev</th>
          <th style="text-align:left;width:110px;">Margin</th>
        </tr>
      </thead>
      <tbody id="pl-tbody"></tbody>
      <tfoot>
        <tr>
          <td>TOTAL <span style="font-size:10px;font-weight:500;color:#9FA4BC;">6 products</span></td>
          <td class="num" style="color:#1500FF;">$383,641</td>
          <td class="num" style="color:#9FA4BC;">$156,203</td>
          <td class="num" style="color:#00BC9E;">$227,436</td>
          <td class="num" style="color:#1500FF;">59.3%</td>
          <td class="num" style="color:#00BC9E;">+$500</td>
          <td class="num" style="color:#ED4F63;">−$670</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- CHARTS -->
  <div class="grid-2">
    <div class="card">
      <div class="card-title">Revenue Mix — FY26 FCST</div>
      <canvas id="revChart"></canvas>
    </div>
    <div class="card">
      <div class="card-title">Margin by Product — FY26 FCST</div>
      <canvas id="marginChart"></canvas>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Quarterly Revenue Progression — FY26 FCST ($K)</div>
    <canvas id="qChart"></canvas>
  </div>

  <!-- BUBBLE CHART -->
  <div class="card bubble-section">
    <div class="card-title">Revenue &amp; Margin Comparison — FY25 Actual vs. FY26 FCST</div>

    <div class="bubble-controls">
      <div class="threshold-control">
        <label for="threshold-slider">Margin Threshold</label>
        <input type="range" id="threshold-slider" min="0" max="100" value="75" step="1">
        <span id="threshold-display">75%</span>
      </div>
      <span class="ctl-hint">Drag to adjust the threshold line</span>
    </div>

    <div id="bubble-wrap">
      <svg id="bubble-chart"></svg>
    </div>

    <div class="bubble-legend">
      <div class="bubble-legend-item">
        <div class="leg-swatch" style="background:#1500FF;"></div>FY25 Actual
      </div>
      <div class="bubble-legend-item">
        <div class="leg-swatch" style="background:#00D7D9;"></div>FY26 FCST
      </div>
      <div class="bubble-legend-item">
        <div class="leg-dash"></div>Margin Threshold
      </div>
      <span style="font-size:10px;font-weight:500;color:#9FA4BC;margin-left:auto;">Bubble size = revenue · Margin % shown above each bubble · Revenue ($k) shown inside</span>
    </div>
  </div>

  <!-- HIGH / WATCH -->
  <div class="grid-2">
    <div class="card" style="border-top:3px solid #00BC9E;">
      <div class="card-title" style="color:#00BC9E;">High Performers</div>
      <table class="ref-table">
        <tr><td>Professional Archive</td><td style="color:#00BC9E;">76.3% margin · $104.4M rev</td></tr>
        <tr><td>Digital Safe</td><td style="color:#00BC9E;">68.5% margin · $66.1M rev · +$2.6M vs budget</td></tr>
        <tr><td>Enterprise Archive</td><td style="color:#00BC9E;">67.2% margin · $106.9M rev · +31% YoY</td></tr>
      </table>
    </div>
    <div class="card" style="border-top:3px solid #ED4F63;">
      <div class="card-title" style="color:#ED4F63;">Watch List</div>
      <table class="ref-table">
        <tr><td>Capture → Mobile</td><td style="color:#ED4F63;">20.6% margin · −16% YoY</td></tr>
        <tr><td>Conduct</td><td style="color:#ED4F63;">23.9% margin · −10% YoY · Q2/Q3 negative profit</td></tr>
        <tr><td>Capture (rollup)</td><td style="color:#ED4F63;">30.0% margin · −23% YoY — sharpest vol drop</td></tr>
        <tr><td>Business Solutions</td><td style="color:#ED4F63;">40.3% margin · −10% YoY</td></tr>
      </table>
    </div>
  </div>

  <!-- NARRATIVE -->
  <div class="narrative-card">
    <div class="card-title">P&L Narrative</div>
    <div style="margin-top:4px;">
      <p>The portfolio benefits from several strong, high-margin products that help balance areas under pressure. PA, DS, and EA all operate near or above 70% margin. Capture is performing at a lower level, with Mobile Capture around 20% margin and bringing the overall Capture margin closer to 30%. This highlights the value of keeping roadmaps closely tied to P&L accountability and making deliberate capacity choices based on contribution margin and long-term portfolio health.</p>
    </div>
  </div>

</div>

<!-- Tooltip lives outside container for fixed positioning -->
<div id="bubble-tooltip"></div>

<script>
/* ── P&L TABLE DATA ── */
const PL_TOP = [
  { name:'Professional Archive', short:'Prof Archive',  rev:104372, exp:24771, profit:79601, margin:76.3, budget:104452, fy25:94119,  q:[24833,25350,26581,27608] },
  { name:'Business Solutions',   short:'Biz Solutions', rev:11162,  exp:6664,  profit:4498,  margin:40.3, budget:11523,  fy25:12346,  q:[2889,2813,2762,2699]    },
  { name:'Enterprise Archive',   short:'Ent Archive',   rev:106938, exp:35046, profit:71892, margin:67.2, budget:108474, fy25:81509,  q:[23220,24791,27021,31906] },
  { name:'Capture',              short:'Capture',       rev:55879,  exp:39108, profit:16771, margin:30.0, budget:55703,  fy25:72212,  q:[12651,13708,14595,14925] },
  { name:'Conduct',              short:'Conduct',       rev:39195,  exp:29822, profit:9372,  margin:23.9, budget:39534,  fy25:43444,  q:[11389,6603,6946,14256]   },
  { name:'Digital Safe',         short:'Digital Safe',  rev:66095,  exp:20792, profit:45302, margin:68.5, budget:63455,  fy25:80681,  q:[17604,17158,16175,15157] },
];

const CAPTURE_CHILDREN = [
  { name:'Mobile',  rev:35726, exp:28367, profit:7359,  margin:20.6, budget:35036, fy25:42491 },
  { name:'Desktop', rev:20153, exp:8778,  profit:11375, margin:56.4, budget:20667, fy25:29672 },
];

const PALETTE = ['#1500FF','#9FA4BC','#00BC9E','#00D7D9','#170035','#7B61FF'];

function mColor(m) {
  if (m >= 65) return '#00BC9E';
  if (m >= 50) return '#00D7D9';
  if (m >= 35) return '#9FA4BC';
  return '#ED4F63';
}

function buildRow(p, isChild) {
  const vsBud  = p.rev - p.budget;
  const yoy    = p.rev - p.fy25;
  const yoyPct = (yoy / p.fy25 * 100).toFixed(1);
  const mc     = mColor(p.margin);

  const nameCell = isChild
    ? `<td><span class="child-prefix">└</span>${p.name}<span class="child-tag">sub</span></td>`
    : `<td>${p.name}</td>`;

  const rowClass = isChild ? 'row-child' : (p.name === 'Capture' ? 'row-parent row-capture' : 'row-parent');
  const numCol   = isChild ? '#7a84a8' : '#1500FF';

  return `<tr class="${rowClass}">
    ${nameCell}
    <td class="num" style="color:${numCol};">$${p.rev.toLocaleString()}</td>
    <td class="num" style="color:#9FA4BC;">$${p.exp.toLocaleString()}</td>
    <td class="num" style="color:#00BC9E;">$${p.profit.toLocaleString()}</td>
    <td class="num" style="color:${mc};font-weight:${isChild?600:700};">${p.margin}%</td>
    <td class="num" style="color:${vsBud>=0?'#00BC9E':'#ED4F63'};">${vsBud>=0?'+':'-'}$${Math.abs(vsBud).toLocaleString()}</td>
    <td class="num" style="color:${yoy>=0?'#00BC9E':'#ED4F63'};">${yoy>=0?'+':''}${yoyPct}%</td>
    <td style="padding:9px 10px 9px 8px;">
      <div class="bar-track"><div class="bar-fill" style="width:${Math.round(p.margin)}%;background:${mc};"></div></div>
    </td>
  </tr>`;
}

const tbody = document.getElementById('pl-tbody');
PL_TOP.forEach(p => {
  tbody.innerHTML += buildRow(p, false);
  if (p.name === 'Capture') CAPTURE_CHILDREN.forEach(c => { tbody.innerHTML += buildRow(c, true); });
});

/* ── CHART.JS PLUGINS ── */
const dataLabelsPlugin = {
  id: 'customLabels',
  afterDatasetsDraw(chart) {
    const { ctx } = chart;
    chart.data.datasets.forEach((dataset, di) => {
      const meta = chart.getDatasetMeta(di);
      if (meta.hidden) return;
      meta.data.forEach((bar, i) => {
        const val = dataset.data[i];
        if (!val && val !== 0) return;
        ctx.save();
        ctx.font = "600 11px 'Manrope', sans-serif";
        ctx.fillStyle = '#ffffff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const type = chart.config.type;
        if (type === 'bar' && chart.options.indexAxis === 'y') {
          const w = bar.x - bar.base;
          const label = val + '%';
          if (w > 40) {
            ctx.fillStyle = '#ffffff';
            ctx.fillText(label, bar.base + w / 2, bar.y);
          } else {
            ctx.fillStyle = '#170035';
            ctx.textAlign = 'left';
            ctx.fillText(label, bar.x + 5, bar.y);
          }
        } else if (type === 'bar') {
          const h = Math.abs(bar.y - bar.base);
          if (h > 18) {
            ctx.fillStyle = '#ffffff';
            ctx.fillText('$' + (val / 1000).toFixed(0) + 'M', bar.x, bar.y + h / 2);
          }
        }
        ctx.restore();
      });
    });
  }
};

const doughnutLabels = {
  id: 'doughnutLabels',
  afterDatasetsDraw(chart) {
    if (chart.config.type !== 'doughnut') return;
    const { ctx } = chart;
    const meta = chart.getDatasetMeta(0);
    const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
    meta.data.forEach((arc, i) => {
      const val  = chart.data.datasets[0].data[i];
      const pct  = (val / total * 100).toFixed(0);
      if (parseFloat(pct) < 7) return;
      const angle = arc.startAngle + (arc.endAngle - arc.startAngle) / 2;
      const midR  = (arc.outerRadius + arc.innerRadius) / 2;
      const cx    = arc.x + Math.cos(angle) * midR;
      const cy    = arc.y + Math.sin(angle) * midR;
      ctx.save();
      ctx.font = "700 11px 'Manrope', sans-serif";
      ctx.fillStyle = '#ffffff';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('$' + (val / 1000).toFixed(0) + 'M', cx, cy - 6);
      ctx.font = "500 10px 'Manrope', sans-serif";
      ctx.fillText(pct + '%', cx, cy + 7);
      ctx.restore();
    });
  }
};

window.addEventListener('load', () => {
  Chart.defaults.font.family = "'Manrope', sans-serif";
  Chart.defaults.color       = '#9FA4BC';
  Chart.defaults.borderColor = '#D1DDE5';
  Chart.register(dataLabelsPlugin, doughnutLabels);

  const byMargin = [...PL_TOP].sort((a, b) => b.margin - a.margin);

  new Chart(document.getElementById('revChart'), {
    type: 'doughnut',
    data: {
      labels: PL_TOP.map(p => p.short),
      datasets: [{ data: PL_TOP.map(p => p.rev), backgroundColor: PALETTE, borderColor: '#ffffff', borderWidth: 2, hoverOffset: 6 }]
    },
    options: {
      responsive: true, cutout: '55%',
      plugins: {
        legend: { position: 'right', labels: { font: { size: 11, weight: '600' }, padding: 10, boxWidth: 12, color: '#170035' } },
        tooltip: { callbacks: { label: ctx => ` $${(ctx.parsed / 1000).toFixed(1)}M (${(ctx.parsed / 383641 * 100).toFixed(1)}%)` } }
      }
    }
  });

  new Chart(document.getElementById('marginChart'), {
    type: 'bar',
    data: {
      labels: byMargin.map(p => p.short),
      datasets: [{ data: byMargin.map(p => p.margin), backgroundColor: byMargin.map(p => mColor(p.margin)), borderRadius: 4, borderWidth: 0 }]
    },
    options: {
      indexAxis: 'y', responsive: true,
      layout: { padding: { right: 40 } },
      plugins: {
        legend: { display: false },
        tooltip: { callbacks: { label: ctx => ` ${ctx.parsed.x}%` } }
      },
      scales: {
        x: { min: 0, max: 100, ticks: { callback: v => v + '%', font: { size: 11 } }, grid: { color: '#EAF3F9' } },
        y: { ticks: { font: { size: 11, weight: '500' }, color: '#170035' }, grid: { display: false } }
      }
    }
  });

  const qDatasets = PL_TOP.map((p, i) => ({
    label: p.short, data: p.q,
    backgroundColor: PALETTE[i], borderWidth: 0, borderRadius: 0
  }));

  new Chart(document.getElementById('qChart'), {
    type: 'bar',
    data: { labels: ['Q1', 'Q2', 'Q3', 'Q4'], datasets: qDatasets },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'right', labels: { font: { size: 11, weight: '600' }, padding: 8, boxWidth: 12, color: '#170035' } },
        tooltip: {
          mode: 'index',
          callbacks: {
            label: ctx => ` ${ctx.dataset.label}: $${(ctx.parsed.y / 1000).toFixed(1)}M`,
            footer: items => 'Total: $' + (items.reduce((s, i) => s + i.parsed.y, 0) / 1000).toFixed(1) + 'M'
          }
        }
      },
      scales: {
        x: { stacked: true, grid: { display: false }, ticks: { font: { size: 12, weight: '600' }, color: '#170035' } },
        y: { stacked: true, ticks: { callback: v => '$' + (v / 1000).toFixed(0) + 'M', font: { size: 11 } }, grid: { color: '#EAF3F9' } }
      }
    }
  });

  const qTotalPlugin = {
    id: 'qTotals',
    afterDraw(chart) {
      if (chart.canvas.id !== 'qChart') return;
      const { ctx, scales: { x, y } } = chart;
      const totals = ['Q1','Q2','Q3','Q4'].map((_, qi) => PL_TOP.reduce((sum, p) => sum + p.q[qi], 0));
      ctx.save();
      ctx.font = "700 11px 'Manrope', sans-serif";
      ctx.fillStyle = '#170035';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      x.ticks.forEach((tick, i) => {
        ctx.fillText('$' + (totals[i] / 1000).toFixed(0) + 'M', x.getPixelForTick(i), y.getPixelForValue(totals[i]) - 4);
      });
      ctx.restore();
    }
  };
  Chart.register(qTotalPlugin);
  Chart.getChart('qChart')?.update();

  /* ── BUBBLE CHART (D3) ── */
  const bubbleData = [
    { name: "Professional Archive", short: "Pro Archive",   rev25: 94119,  rev26: 104372, margin25: 0.76, margin26: 0.763 },
    { name: "Business Solutions",   short: "Biz Solutions", rev25: 12346,  rev26: 11162,  margin25: 0.40, margin26: 0.403 },
    { name: "Enterprise Archive",   short: "Ent Archive",   rev25: 81509,  rev26: 106938, margin25: 0.61, margin26: 0.672 },
    { name: "Capture",              short: "Capture",       rev25: 72212,  rev26: 55879,  margin25: 0.48, margin26: 0.30  },
    { name: "Conduct",              short: "Conduct",       rev25: 43444,  rev26: 39195,  margin25: 0.40, margin26: 0.239 },
    { name: "Digital Safe",         short: "Digital Safe",  rev25: 80681,  rev26: 66095,  margin25: 0.72, margin26: 0.685 },
  ];

  const PRIMARY = "#1500FF";
  const TEAL1   = "#00D7D9";
  const RED     = "#ED4F63";

  const wrap     = document.getElementById('bubble-wrap');
  const totalW   = wrap.clientWidth;
  const BW       = totalW - 4;
  const BH       = Math.round(BW * 0.50);
  const BM       = { top: 36, right: 52, bottom: 76, left: 54 };
  const iW       = BW - BM.left - BM.right;
  const iH       = BH - BM.top - BM.bottom;

  const svg = d3.select('#bubble-chart')
    .attr('width', BW)
    .attr('height', BH);

  const g = svg.append('g').attr('transform', `translate(${BM.left},${BM.top})`);

  const products = bubbleData.map(d => d.name);
  const bandW    = iW / products.length;
  const offset   = bandW * 0.17;

  const allRevs  = bubbleData.flatMap(d => [d.rev25, d.rev26]);
  const rScale   = d3.scaleSqrt().domain([0, d3.max(allRevs)]).range([10, 42]);
  const yScale   = d3.scaleLinear().domain([0, 1]).range([iH, 0]);

  function bx(name) {
    return (products.indexOf(name) + 0.5) * bandW;
  }

  // Horizontal grid
  g.append('g').attr('class', 'bGrid')
    .call(d3.axisLeft(yScale).tickSize(-iW).tickFormat('').ticks(5))
    .selectAll('line').attr('stroke', '#EAF3F9').attr('stroke-dasharray', '4,3');
  g.select('.bGrid .domain').remove();

  // Y axis
  g.append('g')
    .call(d3.axisLeft(yScale).ticks(5).tickFormat(d => `${(d*100).toFixed(0)}%`))
    .selectAll('text')
    .attr('font-family', 'Manrope, sans-serif')
    .attr('font-size', 10)
    .attr('font-weight', 600)
    .attr('fill', '#9FA4BC');

  // Y label
  svg.append('text')
    .attr('transform', 'rotate(-90)')
    .attr('x', -(BM.top + iH / 2))
    .attr('y', 14)
    .attr('text-anchor', 'middle')
    .attr('font-family', 'Manrope, sans-serif')
    .attr('font-size', 10)
    .attr('font-weight', 700)
    .attr('fill', '#9FA4BC')
    .attr('letter-spacing', '0.08em')
    .text('PRODUCT MARGIN');

  // Band separators
  bubbleData.forEach((d, i) => {
    if (i > 0) {
      g.append('line')
        .attr('x1', i * bandW).attr('x2', i * bandW)
        .attr('y1', 0).attr('y2', iH)
        .attr('stroke', '#EAF3F9')
        .attr('stroke-width', 1);
    }
  });

  // Threshold line
  let threshold = 0.75;

  const threshLine = g.append('line')
    .attr('x1', 0).attr('x2', iW)
    .attr('y1', yScale(threshold)).attr('y2', yScale(threshold))
    .attr('stroke', RED)
    .attr('stroke-width', 1.5)
    .attr('stroke-dasharray', '5,4')
    .attr('opacity', 0.85);

  const threshPill = g.append('rect')
    .attr('x', iW + 4)
    .attr('y', yScale(threshold) - 9)
    .attr('width', 36).attr('height', 15)
    .attr('fill', RED).attr('rx', 3);

  const threshLabel = g.append('text')
    .attr('x', iW + 22)
    .attr('y', yScale(threshold) + 3.5)
    .attr('font-family', 'Manrope, sans-serif')
    .attr('font-size', 9).attr('font-weight', 800)
    .attr('fill', '#fff').attr('text-anchor', 'middle')
    .text('75%');

  // Product groups
  const tooltip = document.getElementById('bubble-tooltip');
  const groups  = g.selectAll('.pg').data(bubbleData).enter().append('g').attr('class', 'pg');

  // Connector
  groups.append('line')
    .attr('x1', d => bx(d.name) - offset).attr('y1', d => yScale(d.margin25))
    .attr('x2', d => bx(d.name) + offset).attr('y2', d => yScale(d.margin26))
    .attr('stroke', '#C6C9E0').attr('stroke-width', 1.2).attr('stroke-dasharray', '3,3');

  // FY25 circles
  groups.append('circle')
    .attr('cx', d => bx(d.name) - offset).attr('cy', d => yScale(d.margin25))
    .attr('r', d => rScale(d.rev25))
    .attr('fill', PRIMARY).attr('fill-opacity', 0.13)
    .attr('stroke', PRIMARY).attr('stroke-width', 2)
    .style('cursor', 'pointer');

  // FY25 revenue label
  groups.append('text')
    .attr('x', d => bx(d.name) - offset).attr('y', d => yScale(d.margin25) + 1)
    .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
    .attr('font-family', 'Manrope, sans-serif').attr('font-size', 9).attr('font-weight', 700)
    .attr('fill', PRIMARY).attr('pointer-events', 'none')
    .text(d => `$${(d.rev25/1000).toFixed(0)}k`);

  // FY26 circles
  groups.append('circle')
    .attr('cx', d => bx(d.name) + offset).attr('cy', d => yScale(d.margin26))
    .attr('r', d => rScale(d.rev26))
    .attr('fill', TEAL1).attr('fill-opacity', 0.16)
    .attr('stroke', TEAL1).attr('stroke-width', 2)
    .style('cursor', 'pointer');

  // FY26 revenue label
  groups.append('text')
    .attr('x', d => bx(d.name) + offset).attr('y', d => yScale(d.margin26) + 1)
    .attr('text-anchor', 'middle').attr('dominant-baseline', 'middle')
    .attr('font-family', 'Manrope, sans-serif').attr('font-size', 9).attr('font-weight', 700)
    .attr('fill', '#007a7b').attr('pointer-events', 'none')
    .text(d => `$${(d.rev26/1000).toFixed(0)}k`);

  // Margin % labels above each bubble
  groups.each(function(d) {
    const grp = d3.select(this);
    const cx25 = bx(d.name) - offset, cx26 = bx(d.name) + offset;
    const r25  = rScale(d.rev25),      r26  = rScale(d.rev26);

    [{ cx: cx25, cy: yScale(d.margin25), r: r25, val: d.margin25 },
     { cx: cx26, cy: yScale(d.margin26), r: r26, val: d.margin26 }].forEach(b => {
      grp.append('text')
        .attr('x', b.cx).attr('y', b.cy - b.r - 5)
        .attr('text-anchor', 'middle')
        .attr('font-family', 'Manrope, sans-serif').attr('font-size', 9).attr('font-weight', 700)
        .attr('fill', '#9FA4BC').attr('pointer-events', 'none')
        .text(`${(b.val * 100).toFixed(0)}%`);
    });
  });

  // Product name labels below
  bubbleData.forEach(d => {
    const cx    = bx(d.name);
    const words = d.short.split(' ');
    const baseY = iH + 18;

    if (words.length === 1) {
      g.append('text')
        .attr('x', cx).attr('y', baseY + 4)
        .attr('text-anchor', 'middle')
        .attr('font-family', 'Manrope, sans-serif').attr('font-size', 11).attr('font-weight', 700)
        .attr('fill', '#170035').text(d.short);
    } else {
      words.forEach((w, i) => {
        g.append('text')
          .attr('x', cx).attr('y', baseY + i * 14)
          .attr('text-anchor', 'middle')
          .attr('font-family', 'Manrope, sans-serif').attr('font-size', 11).attr('font-weight', 700)
          .attr('fill', '#170035').text(w);
      });
    }

    g.append('line')
      .attr('x1', cx).attr('x2', cx)
      .attr('y1', iH).attr('y2', iH + 5)
      .attr('stroke', '#D1DDE5').attr('stroke-width', 1);
  });

  // Tooltip
  function showTip(event, d) {
    const delta    = ((d.margin26 - d.margin25) * 100).toFixed(0);
    const sign     = delta > 0 ? '+' : '';
    const revChg   = (((d.rev26 - d.rev25) / d.rev25) * 100).toFixed(1);
    const revSign  = revChg > 0 ? '+' : '';
    tooltip.innerHTML = `
      <span class="t-name">${d.name}</span>
      <div class="t-section">Revenue</div>
      <div class="t-row"><span>FY25 Actual</span><span>$${d.rev25.toLocaleString()}</span></div>
      <div class="t-row"><span>FY26 FCST</span><span>$${d.rev26.toLocaleString()} (${revSign}${revChg}%)</span></div>
      <hr class="t-divider">
      <div class="t-section">Margin</div>
      <div class="t-row"><span>FY25 Actual</span><span>${(d.margin25*100).toFixed(1)}%</span></div>
      <div class="t-row"><span>FY26 FCST</span><span>${(d.margin26*100).toFixed(1)}% (${sign}${delta}pp)</span></div>
    `;
    tooltip.style.opacity = 1;
    tooltip.style.left = (event.clientX + 16) + 'px';
    tooltip.style.top  = (event.clientY + 16) + 'px';
  }

  groups.on('mousemove', showTip).on('mouseleave', () => { tooltip.style.opacity = 0; });

  // Threshold slider
  document.getElementById('threshold-slider').addEventListener('input', function() {
    threshold = this.value / 100;
    document.getElementById('threshold-display').textContent = this.value + '%';
    const y = yScale(threshold);
    threshLine.attr('y1', y).attr('y2', y);
    threshPill.attr('y', y - 9);
    threshLabel.attr('y', y + 3.5).text(this.value + '%');
  });
});
</script>
</body>
</html>
